<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game 2D Top-Down</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #1a1a2e;
            color: white;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #game-map {
            position: absolute;
            width: 2000px;
            height: 2000px;
            background-color: #2d5a27;
            transform-origin: 0 0;
            transition: transform 0.1s linear;
        }
        
        .tile {
            position: absolute;
            width: 50px;
            height: 50px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tile:hover {
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            z-index: 5;
        }
        
        .character {
            position: absolute;
            z-index: 10;
            pointer-events: none;
            transition: left 0.4s linear, top 0.4s linear;
        }
        
        .player {
            z-index: 20;
        }
        
        .npc {
            z-index: 15;
        }
        
        .player-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 30;
        }
        
        .chat-message {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            max-width: 200px;
            word-wrap: break-word;
            z-index: 35;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            border-left: 3px solid #4CAF50;
        }
        
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            color: white;
            padding: 15px;
            border-radius: 15px;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        #ui h3 {
            margin-bottom: 10px;
            color: #ffcc00;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #ui div {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            z-index: 100;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        #logout-btn:hover {
            background: rgba(220, 53, 69, 1);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        
        #instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            color: white;
            padding: 15px;
            border-radius: 15px;
            z-index: 100;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        #instructions p {
            margin: 5px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 46, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffcc00;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .movement-arrow {
            position: absolute;
            z-index: 9;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .online-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 12px;
            height: 12px;
            background-color: #4CAF50;
            border-radius: 50%;
            border: 2px solid #1a1a2e;
            z-index: 31;
        }
        
        .offline {
            filter: grayscale(70%);
            opacity: 0.5;
        }
        
        /* Chat System Styles */
        #chat-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 350px;
            height: 400px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            z-index: 100;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #chat-header {
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #chat-header h3 {
            color: #ffcc00;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .own-message {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
            align-self: flex-end;
        }
        
        .other-message {
            background: rgba(33, 150, 243, 0.2);
            border-left: 3px solid #2196F3;
            align-self: flex-start;
        }
        
        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
            color: #ffcc00;
        }
        
        .message-content {
            font-size: 14px;
        }
        
        .message-time {
            font-size: 10px;
            opacity: 0.7;
            text-align: right;
            margin-top: 5px;
        }
        
        #chat-input-container {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
        }
        
        #chat-input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }
        
        #chat-input:focus {
            border-color: #ffcc00;
            background: rgba(255, 255, 255, 0.15);
        }
        
        #chat-send-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        #chat-send-btn:hover {
            background: linear-gradient(135deg, #45a049, #1B5E20);
            transform: translateY(-2px);
        }
        
        #chat-toggle-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }
        
        #chat-toggle-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }
        
        /* Scrollbar styling */
        #chat-messages::-webkit-scrollbar {
            width: 5px;
        }
        
        #chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        
        #chat-messages::-webkit-scrollbar-thumb {
            background: #ffcc00;
            border-radius: 5px;
        }
        
        .no-messages {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            margin-top: 50%;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Đang tải game...</p>
        </div>
        
        <div id="game-map"></div>
        
        <div id="ui">
            <h3><i class="fas fa-info-circle"></i> Thông Tin Game</h3>
            <div><i class="fas fa-user"></i> Vị trí: <span id="position">0, 0</span></div>
            <div><i class="fas fa-users"></i> Người chơi online: <span id="player-count">1</span></div>
            <div><i class="fas fa-running"></i> Di chuyển tới: <span id="target-position">-</span></div>
        </div>
        
        <button id="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Đăng Xuất
        </button>
        
        <!-- Chat Toggle Button -->
        <button id="chat-toggle-btn">
            <i class="fas fa-comment-alt"></i>
        </button>
        
        <!-- Chat Container -->
        <div id="chat-container" style="display: none;">
            <div id="chat-header">
                <h3><i class="fas fa-comments"></i> Chat Game</h3>
            </div>
            <div id="chat-messages">
                <div class="no-messages">Chưa có tin nhắn nào. Hãy bắt đầu trò chuyện!</div>
            </div>
            <div id="chat-input-container">
                <input type="text" id="chat-input" placeholder="Nhập tin nhắn của bạn...">
                <button id="chat-send-btn">
                    <i class="fas fa-paper-plane"></i> Gửi
                </button>
            </div>
        </div>
        
        <div id="instructions">
            <p><i class="fas fa-mouse-pointer"></i> Di chuột vào ô và nhấp để di chuyển nhân vật</p>
            <p><i class="fas fa-comment"></i> Nhấn vào biểu tượng chat để trò chuyện</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD8J4dbeW7qqMHC8DpMhWS89qbQWrabklQ",
            authDomain: "tlgame-51605.firebaseapp.com",
            databaseURL: "https://tlgame-51605-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "tlgame-51605",
            storageBucket: "tlgame-51605.firebasestorage.app",
            messagingSenderId: "992801405826",
            appId: "1:992801405826:web:490eeab62acff57f346d9b",
            measurementId: "G-BX4J31QDYR"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Game variables
        const TILE_SIZE = 50;
        const CHARACTER_HEIGHT = 2 * TILE_SIZE;
        const MOVE_SPEED = 2.5; // 2.5 tiles per second
        let currentUser = null;
        let playerId = null;
        let playerPosition = { x: 0, y: 0 };
        let targetPosition = { x: 0, y: 0 };
        let isMoving = false;
        let players = {};
        let playerStatus = {};
        let npcPosition = { x: 5, y: 5 };
        let movementArrow = null;
        let chatMessages = {};

        // DOM elements
        const gameContainer = document.getElementById('game-container');
        const gameMap = document.getElementById('game-map');
        const positionDisplay = document.getElementById('position');
        const targetPositionDisplay = document.getElementById('target-position');
        const playerCountDisplay = document.getElementById('player-count');
        const logoutBtn = document.getElementById('logout-btn');
        const loadingElement = document.getElementById('loading');
        
        // Chat elements
        const chatContainer = document.getElementById('chat-container');
        const chatToggleBtn = document.getElementById('chat-toggle-btn');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');

        // Initialize game
        function initGame() {
            // Check authentication
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    playerId = user.uid;
                    setupGame();
                } else {
                    window.location.href = 'login.html';
                }
            });

            // Logout button
            logoutBtn.addEventListener('click', () => {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                });
            });

            // Chat toggle button
            chatToggleBtn.addEventListener('click', toggleChat);
            
            // Chat send button
            chatSendBtn.addEventListener('click', sendChatMessage);
            
            // Enter key to send message
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
        }

        // Setup game
        function setupGame() {
            // Create map tiles
            createMapTiles();
            
            // Create player character
            createPlayerCharacter();
            
            // Create NPC
            createNPC();
            
            // Load initial player position
            loadPlayerPosition();
            
            // Start listening for other players
            startPlayerListener();
            
            // Start player status listener
            startPlayerStatusListener();
            
            // Start chat listener
            startChatListener();
            
            // Update player status regularly
            setInterval(updatePlayerStatus, 10000);
            
            // Hide loading screen
            setTimeout(() => {
                loadingElement.style.display = 'none';
            }, 1000);
        }

        // Create map tiles
        function createMapTiles() {
            const MAP_SIZE = 40; // 40x40 tiles (2000px / 50px)
            
            for (let y = 0; y < MAP_SIZE; y++) {
                for (let x = 0; x < MAP_SIZE; x++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    tile.dataset.x = x;
                    tile.dataset.y = y;
                    
                    // Calculate position
                    tile.style.left = `${x * TILE_SIZE}px`;
                    tile.style.top = `${y * TILE_SIZE}px`;
                    
                    // Add click event
                    tile.addEventListener('click', (e) => {
                        const targetX = parseInt(e.target.dataset.x);
                        const targetY = parseInt(e.target.dataset.y);
                        
                        if (!isMoving && (targetX !== playerPosition.x || targetY !== playerPosition.y)) {
                            movePlayer(targetX, targetY);
                        }
                    });
                    
                    gameMap.appendChild(tile);
                }
            }
        }

        // Create player character
        function createPlayerCharacter() {
            const playerElement = document.createElement('img');
            playerElement.src = 'https://static.vecteezy.com/system/resources/thumbnails/028/652/011/small/pixel-art-student-character-png.png';
            playerElement.className = 'character player';
            playerElement.id = `player-${playerId}`;
            playerElement.style.width = 'auto';
            playerElement.style.height = `${CHARACTER_HEIGHT}px`;
            playerElement.style.left = '0px';
            playerElement.style.top = '0px';
            gameMap.appendChild(playerElement);
            
            // Create player label
            const playerLabel = document.createElement('div');
            playerLabel.className = 'player-label';
            playerLabel.id = `player-label-${playerId}`;
            playerLabel.textContent = currentUser.email.split('@')[0];
            playerElement.appendChild(playerLabel);
            
            // Create online indicator
            const onlineIndicator = document.createElement('div');
            onlineIndicator.className = 'online-indicator';
            onlineIndicator.id = `online-indicator-${playerId}`;
            playerElement.appendChild(onlineIndicator);
            
            // Update player position
            updatePlayerPosition();
        }

        // Create NPC
        function createNPC() {
            const npcElement = document.createElement('img');
            npcElement.src = 'https://static.vecteezy.com/system/resources/thumbnails/027/190/544/small/pixel-art-black-office-suit-man-character-2-png.png';
            npcElement.className = 'character npc';
            npcElement.id = 'npc';
            npcElement.style.width = 'auto';
            npcElement.style.height = `${CHARACTER_HEIGHT}px`;
            gameMap.appendChild(npcElement);
            
            // Create NPC label
            const npcLabel = document.createElement('div');
            npcLabel.className = 'player-label';
            npcLabel.textContent = 'NPC';
            npcElement.appendChild(npcLabel);
            
            // Position NPC
            positionCharacter(npcElement, npcPosition.x, npcPosition.y);
        }

        // Move player to new position with smooth animation
        function movePlayer(x, y) {
            if (isMoving) return;
            
            targetPosition = { x: x, y: y };
            targetPositionDisplay.textContent = `${x}, ${y}`;
            
            // Calculate movement duration based on distance
            const dx = Math.abs(x - playerPosition.x);
            const dy = Math.abs(y - playerPosition.y);
            const distance = Math.sqrt(dx * dx + dy * dy);
            const duration = distance / MOVE_SPEED * 1000; // Convert to milliseconds
            
            // Create movement arrow
            createMovementArrow(playerPosition.x, playerPosition.y, x, y);
            
            // Start movement
            isMoving = true;
            const playerElement = document.getElementById(`player-${playerId}`);
            
            // Update position gradually
            const startX = playerPosition.x;
            const startY = playerPosition.y;
            const startTime = Date.now();
            
            function animateMovement() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const currentX = startX + (x - startX) * progress;
                const currentY = startY + (y - startY) * progress;
                
                // Update visual position
                positionCharacter(playerElement, currentX, currentY);
                
                // Update movement arrow
                updateMovementArrow(currentX, currentY, x, y);
                
                // Update camera continuously during movement
                updateCameraDuringMovement(currentX, currentY);
                
                if (progress < 1) {
                    requestAnimationFrame(animateMovement);
                } else {
                    // Movement complete
                    playerPosition.x = x;
                    playerPosition.y = y;
                    positionDisplay.textContent = `${x}, ${y}`;
                    isMoving = false;
                    targetPositionDisplay.textContent = '-';
                    
                    // Remove movement arrow
                    removeMovementArrow();
                    
                    // Save position to Firestore
                    savePlayerPosition();
                }
            }
            
            animateMovement();
        }

        // Create movement arrow
        function createMovementArrow(fromX, fromY, toX, toY) {
            // Remove existing arrow
            removeMovementArrow();
            
            // Create arrow element
            movementArrow = document.createElement('div');
            movementArrow.className = 'movement-arrow';
            movementArrow.id = 'movement-arrow';
            
            // Calculate positions
            const fromPixelX = fromX * TILE_SIZE + TILE_SIZE / 2;
            const fromPixelY = fromY * TILE_SIZE + TILE_SIZE / 2 - (CHARACTER_HEIGHT - TILE_SIZE) / 2;
            const toPixelX = toX * TILE_SIZE + TILE_SIZE / 2;
            const toPixelY = toY * TILE_SIZE + TILE_SIZE / 2 - (CHARACTER_HEngth - TILE_SIZE) / 2;
            
            // Calculate arrow properties
            const dx = toPixelX - fromPixelX;
            const dy = toPixelY - fromPixelY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            // Set arrow style
            movementArrow.style.width = `${length}px`;
            movementArrow.style.height = '4px';
            movementArrow.style.left = `${fromPixelX}px`;
            movementArrow.style.top = `${fromPixelY}px`;
            movementArrow.style.transform = `rotate(${angle}deg)`;
            movementArrow.style.transformOrigin = '0 0';
            movementArrow.style.background = `repeating-linear-gradient(
                to right,
                #ffcc00,
                #ffcc00 10px,
                transparent 10px,
                transparent 20px
            )`;
            
            gameMap.appendChild(movementArrow);
        }

        // Update movement arrow
        function updateMovementArrow(fromX, fromY, toX, toY) {
            if (!movementArrow) return;
            
            // Calculate positions
            const fromPixelX = fromX * TILE_SIZE + TILE_SIZE / 2;
            const fromPixelY = fromY * TILE_SIZE + TILE_SIZE / 2 - (CHARACTER_HEIGHT - TILE_SIZE) / 2;
            const toPixelX = toX * TILE_SIZE + TILE_SIZE / 2;
            const toPixelY = toY * TILE_SIZE + TILE_SIZE / 2 - (CHARACTER_HEIGHT - TILE_SIZE) / 2;
            
            // Calculate arrow properties
            const dx = toPixelX - fromPixelX;
            const dy = toPixelY - fromPixelY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            // Update arrow
            movementArrow.style.width = `${length}px`;
            movementArrow.style.left = `${fromPixelX}px`;
            movementArrow.style.top = `${fromPixelY}px`;
            movementArrow.style.transform = `rotate(${angle}deg)`;
        }

        // Remove movement arrow
        function removeMovementArrow() {
            if (movementArrow) {
                movementArrow.remove();
                movementArrow = null;
            }
        }

        // Position a character at specific coordinates
        function positionCharacter(element, x, y) {
            const posX = x * TILE_SIZE;
            const posY = y * TILE_SIZE - (CHARACTER_HEIGHT - TILE_SIZE);
            
            element.style.left = `${posX}px`;
            element.style.top = `${posY}px`;
        }

        // Update player position in DOM
        function updatePlayerPosition() {
            const playerElement = document.getElementById(`player-${playerId}`);
            if (playerElement) {
                positionCharacter(playerElement, playerPosition.x, playerPosition.y);
                updateCamera();
            }
        }

        // Update camera to follow player
        function updateCamera() {
            updateCameraPosition(playerPosition.x, playerPosition.y);
        }

        // Update camera during movement
        function updateCameraDuringMovement(currentX, currentY) {
            updateCameraPosition(currentX, currentY);
        }

        // Update camera position
        function updateCameraPosition(x, y) {
            const containerWidth = gameContainer.clientWidth;
            const containerHeight = gameContainer.clientHeight;
            
            // Calculate center position for camera
            const centerX = x * TILE_SIZE + TILE_SIZE / 2;
            const centerY = y * TILE_SIZE + TILE_SIZE / 2;
            
            // Calculate translation to center the player
            const translateX = containerWidth / 2 - centerX;
            const translateY = containerHeight / 2 - centerY;
            
            // Apply transform to game map with smooth transition
            gameMap.style.transform = `translate(${translateX}px, ${translateY}px)`;
        }

        // Save player position to Firestore
        function savePlayerPosition() {
            if (!playerId) return;
            
            db.collection('playerPositions').doc(playerId).set({
                x: playerPosition.x,
                y: playerPosition.y,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                playerId: playerId,
                email: currentUser.email,
                isMoving: isMoving,
                targetX: targetPosition.x,
                targetY: targetPosition.y
            });
        }

        // Update player status
        function updatePlayerStatus() {
            if (!playerId) return;
            
            db.collection('playerStatus').doc(playerId).set({
                playerId: playerId,
                email: currentUser.email,
                lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                online: true
            });
        }

        // Load player position from Firestore
        function loadPlayerPosition() {
            if (!playerId) return;
            
            db.collection('playerPositions')
                .doc(playerId)
                .get()
                .then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        playerPosition.x = data.x;
                        playerPosition.y = data.y;
                        positionDisplay.textContent = `${playerPosition.x}, ${playerPosition.y}`;
                        updatePlayerPosition();
                    }
                });
        }

        // Start listening for other players' positions
        function startPlayerListener() {
            db.collection('playerPositions')
                .onSnapshot((snapshot) => {
                    const currentPlayers = {};
                    let onlineCount = 0;
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const playerId = data.playerId;
                        
                        // Only show online players
                        if (playerStatus[playerId] && playerStatus[playerId].online) {
                            if (playerId !== currentUser.uid) {
                                currentPlayers[playerId] = data;
                                onlineCount++;
                                
                                // Create or update player character
                                createOrUpdateOtherPlayer(
                                    playerId, 
                                    data.x, 
                                    data.y, 
                                    data.email,
                                    data.isMoving,
                                    data.targetX,
                                    data.targetY
                                );
                            }
                        }
                    });
                    
                    players = currentPlayers;
                    playerCountDisplay.textContent = onlineCount + 1; // +1 for current player
                    
                    // Remove players that are offline
                    removeOfflinePlayers(currentPlayers);
                });
        }

        // Start listening for player status
        function startPlayerStatusListener() {
            // Update current player status
            updatePlayerStatus();
            
            // Listen for other players' status
            db.collection('playerStatus')
                .onSnapshot((snapshot) => {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        playerStatus[data.playerId] = data;
                        
                        // Set timeout to mark as offline after 30 seconds
                        setTimeout(() => {
                            if (data.playerId !== currentUser.uid) {
                                const now = new Date().getTime();
                                const lastActive = data.lastActive?.toDate()?.getTime() || 0;
                                
                                if (now - lastActive > 30000) {
                                    playerStatus[data.playerId].online = false;
                                    
                                    // Hide offline player
                                    const playerElement = document.getElementById(`player-${data.playerId}`);
                                    if (playerElement) {
                                        playerElement.classList.add('offline');
                                    }
                                }
                            }
                        }, 30000);
                    });
                });
        }

        // Create or update other player character
        function createOrUpdateOtherPlayer(id, x, y, email, isMoving, targetX, targetY) {
            let playerElement = document.getElementById(`player-${id}`);
            let isNewPlayer = false;
            
            if (!playerElement) {
                playerElement = document.createElement('img');
                playerElement.src = 'https://static.vecteezy.com/system/resources/thumbnails/028/652/011/small/pixel-art-student-character-png.png';
                playerElement.className = 'character';
                playerElement.id = `player-${id}`;
                playerElement.style.width = 'auto';
                playerElement.style.height = `${CHARACTER_HEIGHT}px`;
                playerElement.style.left = '0px';
                playerElement.style.top = '0px';
                gameMap.appendChild(playerElement);
                
                // Create player label
                const playerLabel = document.createElement('div');
                playerLabel.className = 'player-label';
                playerLabel.id = `player-label-${id}`;
                playerLabel.textContent = email.split('@')[0];
                playerElement.appendChild(playerLabel);
                
                // Create online indicator
                const onlineIndicator = document.createElement('div');
                onlineIndicator.className = 'online-indicator';
                onlineIndicator.id = `online-indicator-${id}`;
                playerElement.appendChild(onlineIndicator);
                
                isNewPlayer = true;
            }
            
            // Remove offline class if player is online
            playerElement.classList.remove('offline');
            
            // Handle movement if player is moving
            if (isMoving && targetX !== undefined && targetY !== undefined) {
                // Calculate progress if we have previous position
                const prevX = parseFloat(playerElement.dataset.prevX || x);
                const prevY = parseFloat(playerElement.dataset.prevY || y);
                
                // Only animate if position changed significantly
                if (Math.abs(prevX - x) > 0.1 || Math.abs(prevY - y) > 0.1 || isNewPlayer) {
                    playerElement.dataset.prevX = x;
                    playerElement.dataset.prevY = y;
                    
                    // Smoothly animate to new position
                    positionCharacter(playerElement, x, y);
                }
            } else {
                // Instant position update if not moving
                positionCharacter(playerElement, x, y);
            }
        }

        // Remove offline players
        function removeOfflinePlayers(currentPlayers) {
            const playerElements = document.querySelectorAll('.character:not(.player):not(#npc)');
            
            playerElements.forEach(element => {
                const id = element.id.replace('player-', '');
                if (!currentPlayers[id] && id !== playerId) {
                    // Mark as offline instead of removing
                    element.classList.add('offline');
                }
            });
        }

        // Chat Functions
        function toggleChat() {
            if (chatContainer.style.display === 'none' || !chatContainer.style.display) {
                chatContainer.style.display = 'flex';
                chatToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
            } else {
                chatContainer.style.display = 'none';
                chatToggleBtn.innerHTML = '<i class="fas fa-comment-alt"></i>';
            }
        }

        function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Clear input
            chatInput.value = '';
            
            // Create message object
            const messageData = {
                playerId: playerId,
                playerName: currentUser.email.split('@')[0],
                message: message,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Save to Firestore
            db.collection('chatMessages').add(messageData);
        }

        function startChatListener() {
            db.collection('chatMessages')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const messageData = change.doc.data();
                            displayChatMessage(messageData);
                            
                            // Auto-remove message after 10 seconds
                            setTimeout(() => {
                                removeChatMessage(change.doc.id, messageData.playerId);
                            }, 10000);
                        }
                    });
                });
        }

        function displayChatMessage(messageData) {
            // Add to chat messages div
            const messageElement = document.createElement('div');
            messageElement.className = `message ${messageData.playerId === playerId ? 'own-message' : 'other-message'}`;
            messageElement.id = `chat-${messageData.playerId}-${Date.now()}`;
            
            const time = new Date(messageData.timestamp?.toDate() || new Date());
            const timeString = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
            
            messageElement.innerHTML = `
                <div class="message-sender">${messageData.playerName}</div>
                <div class="message-content">${messageData.message}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            // Remove "no messages" text if it exists
            const noMessages = document.querySelector('.no-messages');
            if (noMessages) {
                noMessages.remove();
            }
            
            // Add to chat messages
            chatMessagesDiv.insertBefore(messageElement, chatMessagesDiv.firstChild);
            
            // Display message above player's head
            if (messageData.playerId === playerId) {
                displayPlayerChatMessage(messageData.message, true);
            } else {
                displayPlayerChatMessage(messageData.message, false, messageData.playerId, messageData.playerName);
            }
        }

        function displayPlayerChatMessage(message, isOwn = false, playerId = null, playerName = null) {
            let targetPlayerId = isOwn ? currentUser.uid : playerId;
            let targetPlayerName = isOwn ? currentUser.email.split('@')[0] : playerName;
            
            const playerElement = document.getElementById(`player-${targetPlayerId}`);
            if (!playerElement) return;
            
            // Remove existing chat message for this player
            const existingChat = playerElement.querySelector('.chat-message');
            if (existingChat) {
                existingChat.remove();
            }
            
            // Create new chat message element
            const chatMessage = document.createElement('div');
            chatMessage.className = 'chat-message';
            chatMessage.id = `chat-msg-${targetPlayerId}-${Date.now()}`;
            chatMessage.textContent = message;
            
            playerElement.appendChild(chatMessage);
            
            // Store reference for later removal
            chatMessages[chatMessage.id] = setTimeout(() => {
                const msgElement = document.getElementById(chatMessage.id);
                if (msgElement) {
                    msgElement.remove();
                }
                delete chatMessages[chatMessage.id];
            }, 10000);
        }

        function removeChatMessage(messageId, playerId) {
            // Remove from Firestore
            db.collection('chatMessages').doc(messageId).delete();
            
            // Remove from player's head
            const playerElement = document.getElementById(`player-${playerId}`);
            if (playerElement) {
                const chatMessage = playerElement.querySelector('.chat-message');
                if (chatMessage) {
                    chatMessage.remove();
                }
            }
            
            // Clear timeout if exists
            const timeoutId = chatMessages[`chat-${playerId}-${Date.now()}`];
            if (timeoutId) {
                clearTimeout(timeoutId);
                delete chatMessages[`chat-${playerId}-${Date.now()}`];
            }
        }

        // Initialize the game when page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
